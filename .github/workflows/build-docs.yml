name: Build Docs
on:
  pull_request:
    branches:
      - main
    paths:
      - "docs/Design/MG/**"
      - "docs/Design/MIS/**"
      - "docs/DevelopmentPlan/**"
      - "docs/HazardAnalysis/**"
      - "docs/ProblemStatementAndGoals/**"
      - "docs/Reflection/**"
      - "docs/SRS/**"
      - "docs/UserGuide/**"
      - "docs/VnVPlan/**"
      - "docs/VnVReport/**"
  push:
    branches:
      - main
    paths:
      - "docs/Design/MG/**"
      - "docs/Design/MIS/**"
      - "docs/DevelopmentPlan/**"
      - "docs/HazardAnalysis/**"
      - "docs/ProblemStatementAndGoals/**"
      - "docs/Reflection/**"
      - "docs/SRS/**"
      - "docs/UserGuide/**"
      - "docs/VnVPlan/**"
      - "docs/VnVReport/**"

env:
  MG_FILENAME: MG.pdf
  MG_DIR: docs/Design/MG
  MIS_FILENAME: MIS.pdf
  MIS_DIR: docs/Design/MIS
  DEVP_FILENAME: DevelopmentPlan.pdf
  DEVP_DIR: docs/DevelopmentPlan
  HAZA_FILENAME: HazardAnalysis.pdf
  HAZA_DIR: docs/HazardAnalysis
  PS_FILENAME: ProblemStatement.pdf
  PS_DIR: docs/ProblemStatementAndGoals
  REFL_FILENAME: Reflection.pdf
  REFL_DIR: docs/Reflection
  SRS_FILENAME: SRS.pdf
  SRS_DIR: docs/SRS
  UGDE_FILENAME: UserGuide.pdf
  UGDE_DIR: docs/UserGuide
  VNVP_FILENAME: VnVPlan.pdf
  VNVP_DIR: docs/VnVPlan
  VNVR_FILENAME: VnVReport.pdf
  VNVR_DIR: docs/VnVReport

jobs:

  # Checks for which PDFs need to be rebuilt
  changes:
    name: üßû Check What Changed
    runs-on: ubuntu-latest
    outputs:
      module_guide: ${{ steps.filter.outputs.module_guide }}
      module_interface_spec: ${{ steps.filter.outputs.module_interface_spec }}
      dev_plan: ${{ steps.filter.outputs.dev_plan }}
      hazard_analysis: ${{ steps.filter.outputs.hazard_analysis }}
      problem_statement: ${{ steps.filter.outputs.problem_statement }}
      reflection: ${{ steps.filter.outputs.reflection }}
      srs: ${{ steps.filter.outputs.srs }}
      user_guide: ${{ steps.filter.outputs.user_guide }}
      vnv_plan: ${{ steps.filter.outputs.vnv_plan }}
      vnv_report: ${{ steps.filter.outputs.vnv_report }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üßû Check What Changed
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            module_guide:
              - '${{ env.MG_DIR }}/**'
            module_interface_spec:
              - '${{ env.MIS_DIR }}/**'
            dev_plan:
              - '${{ env.DEVP_DIR }}/**'
            hazard_analysis:
              - '${{ env.HAZA_DIR }}/**'
            problem_statement:
              - '${{ env.PS_DIR }}/**'
            reflection:
              - '${{ env.REFL_DIR }}/**'
            srs:
              - '${{ env.SRS_DIR }}/**'
            user_guide:
              - '${{ env.UGDE_DIR }}/**'
            vnv_plan:
              - '${{ env.VNVP_DIR }}/**'
            vnv_report:
              - '${{ env.VNVR_DIR }}/**'

  build_module_guide:
    name: üèó Build Module Guide
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.module_guide == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make MG

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.MG_FILENAME }}
          path: "${{ env.MG_DIR }}/${{ env.MG_FILENAME }}"

  build_module_interface_spec:
    name: üèó Build Module Interface Specification
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.module_interface_spec == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make MIS

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.MIS_FILENAME }}
          path: "${{ env.MIS_DIR }}/${{ env.MIS_FILENAME }}"

  build_dev_plan:
    name: üèó Build Development Plan
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.dev_plan == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make DevP

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.DEVP_FILENAME }}
          path: "${{ env.DEVP_DIR }}/${{ env.DEVP_FILENAME }}"

  build_hazard_analysis:
    name: üèó Build Hazard Analysis
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.hazard_analysis == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make HazA

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.HAZA_FILENAME }}
          path: "${{ env.HAZA_DIR }}/${{ env.HAZA_FILENAME }}"

  build_problem_statement:
    name: üèó Build Problem Statement & Goals
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.problem_statement == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make PS

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PS_FILENAME }}
          path: "${{ env.PS_DIR }}/${{ env.PS_FILENAME }}"

  build_reflection:
    name: üèó Build Reflection Report
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.reflection == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make Refl

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.REFL_FILENAME }}
          path: "${{ env.REFL_DIR }}/${{ env.REFL_FILENAME }}"

  build_srs:
    name: üèó Build Software Requirements Specification
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.srs == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make SRS

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.SRS_FILENAME }}
          path: "${{ env.SRS_DIR }}/${{ env.SRS_FILENAME }}"

  build_user_guide:
    name: üèó Build User Guide
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.user_guide == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make UGde

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.UGDE_FILENAME }}
          path: "${{ env.UGDE_DIR }}/${{ env.UGDE_FILENAME }}"

  build_vnv_plan:
    name: üèó Build System Verification and Validation Plan
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.vnv_plan == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make VnVP

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.VNVP_FILENAME }}
          path: "${{ env.VNVP_DIR }}/${{ env.VNVP_FILENAME }}"

  build_vnv_report:
    name: üèó Build System Verification and Validation Report
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.vnv_report == 'true' }}
    steps:
      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üë∑ Build LaTeX PDF
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: |
            apk add --update-cache make
            cd docs
            make VnVR

      - name: üíæ Save LaTeX PDF
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.VNVR_FILENAME }}
          path: "${{ env.VNVR_DIR }}/${{ env.VNVR_FILENAME }}"

  publish_pdfs:
    name: üöÄ Publish Built LaTeX PDFs
    needs:
      - changes
      - build_module_guide
      - build_module_interface_spec
      - build_dev_plan
      - build_hazard_analysis
      - build_problem_statement
      - build_reflection
      - build_srs
      - build_user_guide
      - build_vnv_plan
      - build_vnv_report
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && always() # runs even if job cancelled
    runs-on: ubuntu-latest
    steps:

      - name: üõé Checkout
        uses: actions/checkout@v3

      - name: üì• Download PDFs
        uses: actions/download-artifact@v3.0.0

      - name: üöß Move PDFs To Correct Directory
        run: |
          [ ! -e "$MG_FILENAME/$MG_FILENAME" ]      || mv -v "$MG_FILENAME/$MG_FILENAME" "$MG_DIR/$MG_FILENAME"
          [ ! -e "$MIS_FILENAME/$MIS_FILENAME" ]    || mv -v "$MIS_FILENAME/$MIS_FILENAME" "$MIS_DIR/$MIS_FILENAME"
          [ ! -e "$DEVP_FILENAME/$DEVP_FILENAME" ]  || mv -v "$DEVP_FILENAME/$DEVP_FILENAME" "$DEVP_DIR/$DEVP_FILENAME"
          [ ! -e "$HAZA_FILENAME/$HAZA_FILENAME" ]  || mv -v "$HAZA_FILENAME/$HAZA_FILENAME" "$HAZA_DIR/$HAZA_FILENAME"
          [ ! -e "$PS_FILENAME/$PS_FILENAME" ]      || mv -v "$PS_FILENAME/$PS_FILENAME" "$PS_DIR/$PS_FILENAME"
          [ ! -e "$REFL_FILENAME/$REFL_FILENAME" ]  || mv -v "$REFL_FILENAME/$REFL_FILENAME" "$REFL_DIR/$REFL_FILENAME"
          [ ! -e "$SRS_FILENAME/$SRS_FILENAME" ]    || mv -v "$SRS_FILENAME/$SRS_FILENAME" "$SRS_DIR/$SRS_FILENAME"
          [ ! -e "$UGDE_FILENAME/$UGDE_FILENAME" ]  || mv -v "$UGDE_FILENAME/$UGDE_FILENAME" "$UGDE_DIR/$UGDE_FILENAME"
          [ ! -e "$VNVP_FILENAME/$VNVP_FILENAME" ]  || mv -v "$VNVP_FILENAME/$VNVP_FILENAME" "$VNVP_DIR/$VNVP_FILENAME"
          [ ! -e "$VNVR_FILENAME/$VNVR_FILENAME" ]  || mv -v "$VNVR_FILENAME/$VNVR_FILENAME" "$VNVR_DIR/$VNVR_FILENAME"

      - name: üöÄ Add & Commit
        uses: EndBug/add-and-commit@v9.1.0
        with:
          default_author: github_actions
          add: "'*.pdf' --force"
          pathspec_error_handling: exitAtEnd
          message: "Built PDFs via Github Actions"
